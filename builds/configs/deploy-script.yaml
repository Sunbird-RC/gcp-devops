steps:
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Authorize Cloud Build'
  entrypoint: 'bash'
  args:
    - -c
    - |
      apt-get install dnsutils jq -y &&
      cloudbuild_external_ip=$(dig @resolver4.opendns.com myip.opendns.com +short) &&
      old_cidr=$(gcloud container clusters describe ${_CLUSTER_NAME_} --zone=${_REGION_} --format json | jq -r '.masterAuthorizedNetworksConfig.cidrBlocks[] | .cidrBlock' | tr '\n' ',') &&
      gcloud container clusters update ${_CLUSTER_NAME_} --zone=${_REGION_} --enable-master-authorized-networks --master-authorized-networks "$old_cidr$cloudbuild_external_ip/32"
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'get-credentials'
  entrypoint: 'gcloud'
  args: ['container', 'clusters', 'get-credentials', '${_CLUSTER_NAME_}', '--project=${_PROJECT_ID_}', '--region=${_REGION_}']
- name: 'gcr.io/${_PROJECT_ID_}/helm:3.12.0'
  id: 'repo-add-nginx'
  entrypoint: 'helm'
  args: ['repo', 'add', 'ingress-nginx', 'https://kubernetes.github.io/ingress-nginx']
  waitFor:
  - 'get-credentials'
- name: 'gcr.io/${_PROJECT_ID_}/helm:3.12.0'
  id: 'repo-update-nginx'
  entrypoint: 'helm'
  args: ['repo', 'update']
  waitFor:
  - 'repo-add-nginx'
- name: 'gcr.io/${_PROJECT_ID_}/helm:3.12.0'
  id: 'ingress-nginx'
  entrypoint: 'helm'
  args: ['upgrade', '--install', '--create-namespace', 'nginx-dev', 'ingress-nginx/ingress-nginx', '-f', '${_NGINX_CONFIG_PATH_}', '-n',  '${_NGINX_CONFIG_NAMESPACE_}']
  waitFor:
  - 'repo-update-nginx'
- name: 'gcr.io/${_PROJECT_ID_}/helm:3.12.0'
  id: 'repo-add-csi'
  entrypoint: 'helm'
  args: ['repo', 'add', 'secrets-store-csi-driver', 'https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts']
- name: 'gcr.io/${_PROJECT_ID_}/helm:3.12.0'
  id: 'repo-update-csi'
  entrypoint: 'helm'
  args: ['repo', 'update']
  waitFor:
  - 'repo-add-csi'
- name: 'gcr.io/${_PROJECT_ID_}/helm:3.12.0'
  id: 'secrets-store-csi-driver'
  entrypoint: 'helm'
  args: ['upgrade', '--install', 'csi-secrets-store', 'secrets-store-csi-driver/secrets-store-csi-driver', '--set', 'syncSecret.enabled=true', '--set', 'enableSecretRotation=true', '-n',  'kube-system']
  waitFor:
  - 'repo-update-csi'
# FOR PUBLIC GKE CLUSTERS ONLY (OPTIONAL)
#- name: 'gcr.io/cloud-builders/kubectl'
#  entrypoint: 'kubectl'
#  args: ['apply', '-f', '${_IPMASQ_CONFIG_PATH_}', '-n', 'kube-system']
- name: 'gcr.io/cloud-builders/kubectl'
  id: 'storage-class'
  entrypoint: 'kubectl'
  args: ['apply', '-f', '${_STORAGE_CLASS_CONFIG_PATH_}']
  waitFor:
  - 'secrets-store-csi-driver'
- name: 'gcr.io/cloud-builders/kubectl'
  id: 'csi-plugin'
  entrypoint: 'kubectl'
  args: ['apply', '-f', '${_CSI_PLUGIN_PATH_}']
  waitFor:
  - 'storage-class'
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Remove worker cidr'
  entrypoint: 'bash'
  args:
    - -c
    - |
      apt-get install dnsutils jq -y &&
      cloudbuild_external_ip=$(dig @resolver4.opendns.com myip.opendns.com +short) &&
      old_cidr=$(gcloud container clusters describe ${_CLUSTER_NAME_} --zone=${_REGION_} --format json | jq -r '.masterAuthorizedNetworksConfig.cidrBlocks[] | .cidrBlock' | tr '\n' ',') &&
      old_cidr=${old_cidr//",$cloudbuild_external_ip/32,"/}
      gcloud container clusters update ${_CLUSTER_NAME_} --zone=${_REGION_} --enable-master-authorized-networks --master-authorized-networks "$old_cidr"
  waitFor:
  - 'csi-plugin'
tags: ['cloud-builders-community']
serviceAccount: "projects/${_PROJECT_ID_}/serviceAccounts/${_SERVICE_ACCOUNT_}"
logsBucket: "gs://${_LOG_BUCKET_}"
substitutions:
  _PROJECT_ID_: ''
  _SERVICE_ACCOUNT_: ''
  _REGION_: ''
  _CLUSTER_NAME_: ''
  _NGINX_CONFIG_PATH_: ''
  _NGINX_CONFIG_NAMESPACE_: ''
  _STORAGE_CLASS_CONFIG_PATH_: ''
  _CSI_PLUGIN_PATH_: ''
  _LOG_BUCKET_: ''
options:
    dynamicSubstitutions: true
    workerPool:
       'projects/${_PROJECT_ID_}/locations/${_REGION_}/workerPools/cloudbuild-private-worker-pool'
